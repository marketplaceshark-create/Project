<!DOCTYPE html>
<html lang="en" ng-app="userApp">
<head>
    <meta charset="UTF-8">
    <title>My Dashboard - Agrivendia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="app.js"></script>
    <style>
        .nav-pills .nav-link.active { background-color: #2E7D32; }
        .nav-pills .nav-link { color: #555; font-weight: 600; border-radius: 50px; padding: 10px 25px; margin: 0 5px; }
        .listing-card { border-left: 5px solid transparent; margin-bottom: 20px; }
        .listing-card.sell { border-color: #2E7D32; }
        .listing-card.buy { border-color: #0d6efd; }
        .bid-item { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 10px; }
    </style>
</head>
<body ng-controller="CustomerDashCtrl">

    <!-- HEADER -->
    <div class="dash-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold m-0"><i class="bi bi-grid-fill me-2"></i> Dashboard</h2>
                <p class="mb-0 opacity-75">Welcome back, {{currentUser.name}}</p>
            </div>
            <div class="d-flex gap-2">
                <a href="index.html" class="btn btn-outline-light rounded-pill btn-sm px-3">Home</a>
                <button ng-click="logout()" class="btn btn-warning rounded-pill btn-sm px-3 fw-bold">Logout</button>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <!-- STATS -->
        <div class="row mb-5">
            <div class="col-md-4"><div class="stats-box"><h2 class="fw-bold text-success">{{myListings.length}}</h2><small class="fw-bold text-muted">ACTIVE SALES</small></div></div>
            <div class="col-md-4"><div class="stats-box"><h2 class="fw-bold text-primary">{{myBuyRequests.length}}</h2><small class="fw-bold text-muted">BUY REQUESTS</small></div></div>
            <div class="col-md-4"><div class="stats-box"><h2 class="fw-bold text-warning">{{incomingBidsCount}}</h2><small class="fw-bold text-muted">PENDING BIDS</small></div></div>
        </div>

        <!-- TABS -->
        <ul class="nav nav-pills justify-content-center mb-4">
            <li class="nav-item"><a class="nav-link" ng-class="{'active': activeTab == 'sell'}" ng-click="activeTab = 'sell'">My Sales</a></li>
            <li class="nav-item"><a class="nav-link" ng-class="{'active': activeTab == 'requests'}" ng-click="activeTab = 'requests'">My Requests</a></li>
            <li class="nav-item"><a class="nav-link" ng-class="{'active': activeTab == 'bids'}" ng-click="activeTab = 'bids'">My Offers</a></li>
        </ul>

        <!-- TAB CONTENT: SALES -->
        <div ng-show="activeTab == 'sell'">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="fw-bold text-success">Selling</h5>
                <a href="product_sell.html" class="btn btn-success rounded-pill btn-sm fw-bold"><i class="bi bi-plus-lg"></i> Post Sale</a>
            </div>
            <div class="listing-card feature-box p-4 sell" ng-repeat="item in myListings">
                <div class="d-flex justify-content-between">
                    <div>
                        <!-- FIX 4: Link to Post Details -->
                        <h5 class="fw-bold">
                            <a href="product_detail.html?id={{item.id}}&type=sell" class="text-dark text-decoration-none">{{item.name}}</a> 
                            <small class="text-muted">({{item.productName}})</small>
                        </h5>
                        <div class="small text-muted">{{item.quantity}} Units | ₹{{item.price}} | {{item.location}}</div>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- FIX 5: Delete Button -->
                        <button class="btn btn-sm btn-outline-danger" ng-click="deletePost(item.id, 'sell')" title="Delete Post"><i class="bi bi-trash"></i></button>
                        
                        <button class="btn btn-sm btn-outline-secondary rounded-pill" ng-click="item.showBids = !item.showBids">
                            {{item.showBids ? 'Hide Offers' : 'View Offers'}}
                            <span class="badge bg-danger rounded-pill ms-1" ng-if="getPendingBidCount(item.id, 'sell') > 0">{{getPendingBidCount(item.id, 'sell')}}</span>
                        </button>
                    </div>
                </div>
                <div ng-if="item.showBids" class="mt-3 border-top pt-3">
                    <div ng-repeat="bid in getBidsForProduct(item.id, 'sell')" class="bid-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{bid.bidder_details.name}}</strong> wants {{bid.quantity}} units at <strong class="text-success">₹{{bid.amount}}</strong>
                            <!-- FIX 3: Show Phone on Accept -->
                            <div ng-if="bid.status === 'ACCEPTED'" class="text-success small fw-bold mt-1">
                                <i class="bi bi-telephone-fill"></i> {{bid.bidder_details.phone}}
                            </div>
                        </div>
                        <div ng-if="bid.status == 'PENDING'">
                            <button class="btn btn-sm btn-success rounded-pill" ng-click="updateBid(bid, 'ACCEPTED')">Accept</button>
                            <button class="btn btn-sm btn-outline-danger rounded-pill" ng-click="updateBid(bid, 'REJECTED')">Reject</button>
                        </div>
                        <div ng-if="bid.status != 'PENDING'" class="badge" ng-class="{'bg-success': bid.status=='ACCEPTED', 'bg-danger': bid.status=='REJECTED'}">{{bid.status}}</div>
                    </div>
                    <div ng-if="getBidsForProduct(item.id, 'sell').length == 0" class="text-muted small">No offers yet.</div>
                </div>
            </div>
        </div>

        <!-- TAB CONTENT: BUY REQUESTS -->
        <div ng-show="activeTab == 'requests'">
            <div class="d-flex justify-content-between mb-3">
                <h5 class="fw-bold text-primary">Buying</h5>
                <a href="product_buy.html" class="btn btn-primary rounded-pill btn-sm fw-bold"><i class="bi bi-plus-lg"></i> Post Request</a>
            </div>
            <div class="listing-card feature-box p-4 buy" ng-repeat="item in myBuyRequests">
                <div class="d-flex justify-content-between">
                    <div>
                        <!-- FIX 4: Link -->
                        <h5 class="fw-bold">
                            <a href="product_detail.html?id={{item.id}}&type=buy" class="text-dark text-decoration-none">{{item.name || 'Buy Request'}}</a>
                        </h5>
                        <div class="small text-muted">Need {{item.quantity}} Units | Target: ₹{{item.price}} | {{item.location}}</div>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                         <!-- FIX 5: Delete Button -->
                         <button class="btn btn-sm btn-outline-danger" ng-click="deletePost(item.id, 'buy')" title="Delete Request"><i class="bi bi-trash"></i></button>

                        <button class="btn btn-sm btn-outline-secondary rounded-pill" ng-click="item.showBids = !item.showBids">
                            View Sellers
                        </button>
                    </div>
                </div>
                <div ng-if="item.showBids" class="mt-3 border-top pt-3">
                    <div ng-repeat="bid in getBidsForProduct(item.id, 'buy')" class="bid-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{bid.bidder_details.name}}</strong> offers {{bid.quantity}} units at <strong class="text-success">₹{{bid.amount}}</strong>
                            <!-- FIX 3: Show Phone on Accept -->
                            <div ng-if="bid.status === 'ACCEPTED'" class="text-success small fw-bold mt-1">
                                <i class="bi bi-telephone-fill"></i> {{bid.bidder_details.phone}}
                            </div>
                        </div>
                        <div ng-if="bid.status == 'PENDING'">
                            <button class="btn btn-sm btn-success rounded-pill" ng-click="updateBid(bid, 'ACCEPTED')">Accept</button>
                            <button class="btn btn-sm btn-outline-danger rounded-pill" ng-click="updateBid(bid, 'REJECTED')">Reject</button>
                        </div>
                        <div ng-if="bid.status != 'PENDING'" class="badge" ng-class="{'bg-success': bid.status=='ACCEPTED', 'bg-danger': bid.status=='REJECTED'}">{{bid.status}}</div>
                    </div>
                    <div ng-if="getBidsForProduct(item.id, 'buy').length == 0" class="text-muted small">No sellers yet.</div>
                </div>
            </div>
        </div>

        <!-- TAB CONTENT: MY BIDS -->
        <div ng-show="activeTab == 'bids'">
            <h5 class="fw-bold mb-3">My Offers</h5>
            <div class="row">
                <div class="col-md-6" ng-repeat="bid in myBids">
                    <div class="feature-box p-3 mb-3 h-100 position-relative">
                        <!-- FIX 5: Delete Bid Button -->
                        <button class="btn btn-sm text-danger position-absolute top-0 end-0 m-2" ng-click="deleteBid(bid.id)"><i class="bi bi-x-lg"></i></button>
                        
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold small text-muted">BID #{{bid.id}}</span>
                            <span class="badge" ng-class="{'bg-warning text-dark': bid.status=='PENDING', 'bg-success': bid.status=='ACCEPTED', 'bg-danger': bid.status=='REJECTED'}">{{bid.status}}</span>
                        </div>
                        <h5 class="mt-2">Offered: <span class="text-success fw-bold">₹{{bid.amount}}</span></h5>
                        <p class="small text-muted">For {{bid.quantity}} units</p>
                        
                        <!-- FIX 3: Show Seller Phone on Accept -->
                        <div ng-if="bid.status == 'ACCEPTED'" class="alert alert-success py-2 small fw-bold">
                            <i class="bi bi-check-circle-fill"></i> Accepted! Contact Owner: <br>
                            <span class="fs-6"><i class="bi bi-telephone-fill"></i> {{bid.sell_post_phone || bid.buy_post_phone}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>